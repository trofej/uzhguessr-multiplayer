<!doctype html>
<html lang="en">
<head>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="UZH Map Guessr â€“ Guess University of Zurich buildings on the map!" />
  <meta name="theme-color" content="#171a2e" />
  <title>UZH Map Guessr</title>

  <!-- Fix favicon 404 -->
  <link rel="icon" href="data:,">

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="leaflet/leaflet.css">
  <script defer src="leaflet/leaflet.js"></script>
</head>

<body>
<main class="container">

<header class="header">
  <h1>UZH Map Guessr</h1>
  <button id="btn-theme" class="btn">ðŸŒž Light Mode</button>
  <button id="btn-sound" class="btn">ðŸ”Š Sound On</button>
</header>

<!-- âœ… START SCREEN -->
<section id="screen-start" class="screen active">
  <h2>Ready to play?</h2>
  <p>
    Team up or face off across ZÃ¼rich. Guess the location of University of Zurich buildings together.
    5 synced rounds â€” each with 15 seconds to lock in your guess.
  </p>

  <button id="btn-open-mp" class="btn primary" style="margin-top:1rem;">ðŸŽ® Multiplayer</button>

  <div id="leaderboard-start">
    <h3>Top Players</h3>

    <table id="leaderboard-table-start">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Points</th>
          <th>Total Distance (km)</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body-start"></tbody>
    </table>
  </div>

  <div id="games-played"></div>
</section>


<!-- ðŸŽ® MULTIPLAYER MENU -->
<section id="screen-mp-menu" class="screen">
  <h2>Multiplayer</h2>

  <label for="mp-name">Nickname</label>
  <input id="mp-name" type="text" maxlength="20" placeholder="Your name">

  <div id="mp-invite-banner" style="
  display:none;
  margin-top:0.8rem;
  padding:0.6rem 1rem;
  border-radius:8px;
  background:#29324d;
  color:#b6c6ff;
  font-weight:600;
  text-align:center;
">
  ðŸ“© Welcome! You scanned a room invite.
</div>

  <button id="btn-create-room" class="btn primary" style="margin-top:1rem;">
    âž• Create Room
  </button>

  <button id="btn-join-room-toggle" class="btn" style="margin-top:1rem;">
    ðŸ”— Join Room
  </button>

  <div id="mp-join-box" style="display:none;margin-top:0.8rem;">
    <input id="mp-join-code" type="text" maxlength="6" placeholder="Room Code">
    <button id="btn-join-room" class="btn primary">Join</button>
  </div>

  <h3 id="mp-open-rooms-title" style="margin-top:1.5rem;">Open Rooms</h3>
  <ul id="mp-room-list" class="mp-room-list"></ul>

  <button id="btn-back-to-start" class="btn" style="margin-top:1.5rem;">
    â¬… Back
  </button>
</section>


<!-- ðŸ  MULTIPLAYER LOBBY -->
<section id="screen-mp-lobby" class="screen">
  <h2>Lobby</h2>

  <div id="mp-room-info">
    Room Code: <strong id="mp-room-code">----</strong><br>
    Players (<span id="mp-player-count">0</span>/10):
  </div>

  <ul id="mp-player-list"></ul>

  <p id="mp-wait-host" style="color:var(--muted);margin-top:1rem;">
    Waiting for host to startâ€¦
  </p>

  <div id="mp-qr-box" style="margin-top:1rem; text-align:center; display:none;">
    <h4>Scan to Join</h4>
    <canvas id="mp-qr" width="180" height="180"></canvas>
  </div>

  <button id="btn-mp-start" class="btn primary" style="display:none;">
    Start Game
  </button>

  <button id="btn-mp-leave" class="btn" style="margin-top:1.5rem;">
    Leave Room
  </button>
</section>


<!-- âœ… GAME SCREEN -->
<section id="screen-game" class="screen">
  <h2 class="sr-only">Game in progress</h2>

  <div class="status">
    <div id="round-indicator">Round 1/10</div>
    <div id="score-indicator">Points: 0</div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="streak-bar"></div>
  
  <div class="top-row">
    <div id="streak-indicator">ðŸ”¥ Streak: 0</div>
    <div id="timer-display">Time left: 30s</div>
  </div>

  <figure class="photo-wrap">
    <img id="question-image" src="" alt="" />
  </figure>

  <h3 id="question-text">Location:</h3>
  <p id="hint-text" style="display:none;"></p>

  <div id="map" class="map-container"></div>

    <div class="controls">
    <button id="btn-hint" class="btn">ðŸ’¡ Hint</button>
    <button id="btn-clear-guess" class="btn" disabled>Clear</button>
    <button id="btn-confirm-guess" class="btn primary" disabled>Confirm</button>
    <button id="btn-next" class="btn" style="display:none;" disabled>Next</button>
  </div>
</section>


<!-- ðŸŸ¦ MULTIPLAYER ROUND RESULTS -->
<section id="screen-mp-round" class="screen">
  <h2 id="mp-round-title">Round Results</h2>

  <!-- ðŸ†• Round Standings Display -->
  <div id="mp-round-standings" class="standings-box" style="display:none;">
    <h3>Round Standings</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Player</th><th>Points</th><th>Distance</th></tr>
      </thead>
      <tbody id="mp-round-standings-body"></tbody>
    </table>
  </div>

  <div id="mp-round-map" class="map-container"></div>
</section>


<!-- RESULTS -->
<section id="screen-result" class="screen">
  <h2>Results</h2>
  <p id="result-summary"></p>

  <!-- (Multiplayer round window) -->
  <div id="mp-round-standings-final" class="standings-box" style="display:none;">
    <h3>Current Standings</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Player</th><th>Points</th></tr>
      </thead>
      <tbody id="mp-standings-body"></tbody>
    </table>
  </div>

  <!-- (Multiplayer final scoreboard) -->
  <div id="mp-final" style="display:none;">
    <h3>Final Standings</h3>
    <table id="mp-final-table">
      <thead>
        <tr><th>#</th><th>Name</th><th>Points</th><th>Total Distance</th></tr>
      </thead>
      <tbody id="mp-final-body"></tbody>
    </table>
  </div>

  <!-- Result map -->
  <div id="result-map" class="map-container"></div>

  <!-- ðŸŒ GLOBAL ALL-TIME LEADERBOARD -->
  <div id="name-entry-final">
    <label for="player-name-final" style="color:var(--muted)">Enter your name for the leaderboard:</label>
    <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
      <input id="player-name-final" type="text" maxlength="20" placeholder="Your name" />
      <button id="btn-save-score-final" class="btn primary">Save Score</button>
    </div>
  </div>

  <!-- ðŸ† FINAL LEADERBOARD ðŸ†-->
  <div id="leaderboard-final">
    <h3>Leaderboard</h3>

    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Points</th>
          <th>Total Distance (km)</th>
        </tr>
      </thead>

      <!-- Required by renderLeaderboard() -->
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <button id="btn-restart" class="btn primary">Play Again</button>
</section>

</main>

<!-- AUDIO -->
<audio id="sound-correct" src="sounds/correct.mp3"></audio>
<audio id="sound-wrong" src="sounds/wrong.mp3"></audio>
<audio id="sound-streak" src="sounds/streak.mp3"></audio>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy,
    doc, updateDoc, increment, getDoc, setDoc,
    onSnapshot, where
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCXMlSFVxzzlunW3Goh_6rMWCnbYCXanRQ",
    authDomain: "uzh-guessr.firebaseapp.com",
    projectId: "uzh-guessr",
    storageBucket: "uzh-guessr.firebasestorage.app",
    messagingSenderId: "599787012847",
    appId: "1:599787012847:web:42efa3f57ee083546c111a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.fbCollection = collection;
  window.fbAddDoc = addDoc;
  window.fbGetDocs = getDocs;
  window.fbQuery = query;
  window.fbOrderBy = orderBy;
  window.fbDoc = doc;
  window.fbUpdateDoc = updateDoc;
  window.fbIncrement = increment;
  window.fbGetDoc = getDoc;
  window.fbSetDoc = setDoc;
  window.fbOnSnapshot = onSnapshot;
  window.fbWhere = where;
</script>

<!-- MAIN SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script src="app.js" type="module"></script>

</body>
</html>
